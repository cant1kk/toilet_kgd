{"ast":null,"code":"import React,{useState,useEffect,useCallback}from'react';import{MapContainer,TileLayer,Marker,Popup,useMapEvents}from'react-leaflet';import{Icon,LatLngBounds}from'leaflet';import'leaflet/dist/leaflet.css';import{toiletAPI}from'../services/api';import{telegramService}from'../services/telegram';import{useTelegramAuth}from'../hooks/useTelegramAuth';import AddToiletModal from'./AddToiletModal';import Legend from'./Legend';import'../styles/map.css';// Fix для иконок Leaflet в React\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";delete Icon.Default.prototype._getIconUrl;Icon.Default.mergeOptions({iconRetinaUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',iconUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png'});// Компонент для обработки событий карты\nfunction MapEventHandler(_ref){let{onMapClick}=_ref;useMapEvents({click:e=>{onMapClick(e.latlng.lat,e.latlng.lng);}});return null;}const MapPage=_ref2=>{let{initialUserLocation,isTelegram}=_ref2;const[toilets,setToilets]=useState([]);const[loading,setLoading]=useState(true);const[showAddModal,setShowAddModal]=useState(false);const[selectedPosition,setSelectedPosition]=useState(null);const[userLocation,setUserLocation]=useState(initialUserLocation||null);const[error,setError]=useState(null);const{user}=useTelegramAuth();// Загрузка туалетов\nconst loadToilets=useCallback(async()=>{try{setLoading(true);setError(null);const data=await toiletAPI.getApproved();setToilets(data);}catch(err){console.error('Error loading toilets:',err);setError('Не удалось загрузить данные о туалетах');if(isTelegram){telegramService.showAlert('Не удалось загрузить данные. Попробуйте обновить страницу.');}}finally{setLoading(false);}},[isTelegram]);useEffect(()=>{loadToilets();},[loadToilets]);// Получение геолокации пользователя\nuseEffect(()=>{if(!userLocation&&navigator.geolocation){navigator.geolocation.getCurrentPosition(position=>{const location={lat:position.coords.latitude,lon:position.coords.longitude};setUserLocation(location);// Поиск близлежащих туалетов\nfindNearbyToilets(location.lat,location.lon);},error=>{console.warn('Geolocation error:',error);if(isTelegram){telegramService.showAlert('Не удалось определить ваше местоположение');}});}},[userLocation,isTelegram]);//Поиск близлежащих туалетов\nconst findNearbyToilets=async(lat,lon)=>{try{const nearby=await toiletAPI.findNearby(lat,lon,5000);// 5km radius\nif(nearby.length>0){setToilets(prev=>{// Объединяем с существующими, удаляя дубликаты\nconst existingIds=new Set(prev.map(t=>t.id));const newToilets=nearby.filter(t=>!existingIds.has(t.id));return[...prev,...newToilets];});if(isTelegram){telegramService.notificationOccurred('success');}}}catch(err){console.error('Error finding nearby toilets:',err);}};// Обработка клика по карте\nconst handleMapClick=(lat,lng)=>{if(!user){if(isTelegram){telegramService.showAlert('Для добавления точек необходимо авторизоваться');}else{alert('Для добавления точек необходимо авторизоваться');}return;}setSelectedPosition({lat,lng});setShowAddModal(true);if(isTelegram){telegramService.impactOccurred('light');}};// Добавление нового туалета\nconst handleAddToilet=async toiletData=>{try{await toiletAPI.add(toiletData);setShowAddModal(false);setSelectedPosition(null);// Перезагружаем список\nawait loadToilets();if(isTelegram){telegramService.showAlert('Точка успешно добавлена и будет проверена модератором');telegramService.notificationOccurred('success');}else{alert('Точка успешно добавлена и будет проверена модератором');}}catch(err){console.error('Error adding toilet:',err);if(isTelegram){telegramService.showAlert('Не удалось добавить точку. Попробуйте позже.');telegramService.notificationOccurred('error');}else{alert('Не удалось добавить точку. Попробуйте позже.');}}};// Определение иконки маркера\nconst getMarkerIcon=type=>{const iconUrls={free:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',paid:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',purchase_required:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png'};return new Icon({iconUrl:iconUrls[type],shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});};// Определение центра карты\nconst getMapCenter=()=>{if(userLocation){return[userLocation.lat,userLocation.lon];}// Центр Калининграда\nreturn[54.710,20.510];};// Определение границ для показа всех маркеров\nconst getMapBounds=()=>{if(toilets.length===0)return null;const bounds=new LatLngBounds([[toilets[0].latitude,toilets[0].longitude],[toilets[0].latitude,toilets[0].longitude]]);toilets.forEach(toilet=>{bounds.extend([toilet.latitude,toilet.longitude]);});if(userLocation){bounds.extend([userLocation.lat,userLocation.lon]);}return bounds;};if(loading){return/*#__PURE__*/_jsxs(\"div\",{className:\"map-loading\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner-border text-primary\",role:\"status\",children:/*#__PURE__*/_jsx(\"span\",{className:\"visually-hidden\",children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430...\"})}),/*#__PURE__*/_jsx(\"p\",{children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430 \\u043A\\u0430\\u0440\\u0442\\u044B...\"})]});}if(error){return/*#__PURE__*/_jsxs(\"div\",{className:\"map-error\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"alert alert-danger\",children:error}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-primary\",onClick:loadToilets,children:\"\\u041F\\u043E\\u043F\\u0440\\u043E\\u0431\\u043E\\u0432\\u0430\\u0442\\u044C \\u0441\\u043D\\u043E\\u0432\\u0430\"})]});}return/*#__PURE__*/_jsxs(\"div\",{className:\"map-page \".concat(isTelegram?'telegram-map':''),children:[/*#__PURE__*/_jsxs(MapContainer,{center:getMapCenter(),zoom:13,className:\"map-container\",bounds:getMapBounds()||undefined,boundsOptions:{padding:[50,50]},children:[/*#__PURE__*/_jsx(TileLayer,{attribution:\"\\xA9 <a href=\\\"https://www.openstreetmap.org/copyright\\\">OpenStreetMap</a> contributors\",url:\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"}),/*#__PURE__*/_jsx(MapEventHandler,{onMapClick:handleMapClick}),userLocation&&/*#__PURE__*/_jsx(Marker,{position:[userLocation.lat,userLocation.lon],icon:new Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),children:/*#__PURE__*/_jsx(Popup,{children:/*#__PURE__*/_jsx(\"strong\",{children:\"\\u0412\\u0430\\u0448\\u0435 \\u043C\\u0435\\u0441\\u0442\\u043E\\u043F\\u043E\\u043B\\u043E\\u0436\\u0435\\u043D\\u0438\\u0435\"})})}),toilets.map(toilet=>/*#__PURE__*/_jsx(Marker,{position:[toilet.latitude,toilet.longitude],icon:getMarkerIcon(toilet.type),children:/*#__PURE__*/_jsx(Popup,{children:/*#__PURE__*/_jsxs(\"div\",{className:\"toilet-popup\",children:[/*#__PURE__*/_jsx(\"h6\",{children:toilet.name}),/*#__PURE__*/_jsxs(\"p\",{className:\"mb-1\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u0410\\u0434\\u0440\\u0435\\u0441:\"}),\" \",toilet.address]}),toilet.price&&/*#__PURE__*/_jsxs(\"p\",{className:\"mb-1\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u0426\\u0435\\u043D\\u0430:\"}),\" \",toilet.price]}),toilet.description&&/*#__PURE__*/_jsxs(\"p\",{className:\"mb-1\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u041E\\u043F\\u0438\\u0441\\u0430\\u043D\\u0438\\u0435:\"}),\" \",toilet.description]}),/*#__PURE__*/_jsx(\"p\",{className:\"mb-0\",children:/*#__PURE__*/_jsx(\"span\",{className:\"badge bg-\".concat(toilet.type==='free'?'success':toilet.type==='paid'?'danger':'warning'),children:toilet.type==='free'?'Бесплатный':toilet.type==='paid'?'Платный':'За покупку'})})]})})},toilet.id))]}),/*#__PURE__*/_jsx(Legend,{isTelegram:isTelegram}),/*#__PURE__*/_jsx(AddToiletModal,{show:showAddModal,onHide:()=>{setShowAddModal(false);setSelectedPosition(null);},onAdd:handleAddToilet,initialPosition:selectedPosition,isTelegram:isTelegram})]});};export default MapPage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}