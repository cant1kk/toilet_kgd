{"ast":null,"code":"import React,{useState,useEffect,useCallback}from'react';import{MapPin,X,AlertTriangle}from'lucide-react';import{Button}from'./ui/button';import{telegramService}from'../services/telegram';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export function GeolocationHandler(_ref){let{onLocationUpdate}=_ref;const[showPermissionPrompt,setShowPermissionPrompt]=useState(false);const[error,setError]=useState('');const[isLoading,setIsLoading]=useState(false);const[hasBeenShown,setHasBeenShown]=useState(false);const handleLocationUpdate=useCallback(position=>{const{latitude,longitude}=position.coords;onLocationUpdate(latitude,longitude);if(telegramService.isTelegramApp()){telegramService.notificationOccurred('success');}},[onLocationUpdate]);const handleLocationError=useCallback(error=>{console.warn('Geolocation error:',error);let message='Не удалось определить ваше местоположение';switch(error.code){case error.PERMISSION_DENIED:message='Доступ к геолокации запрещен. Пожалуйста, разрешите доступ в настройках.';break;case error.POSITION_UNAVAILABLE:message='Информация о местоположении недоступна.';break;case error.TIMEOUT:message='Время ожидания геолокации истекло.';break;}setError(message);if(telegramService.isTelegramApp()){telegramService.showAlert(message);telegramService.notificationOccurred('error');}},[]);const requestLocationWithTelegramButton=()=>{if(telegramService.isTelegramApp()){// Используем новый метод для показа кнопки геолокации\ntelegramService.showGeolocationButton(()=>{requestLocation();});// Показываем инструкцию\ntelegramService.showAlert('Нажмите на синюю кнопку внизу \"📍 Определить местоположение\", чтобы мы могли показать ближайшие туалеты.');}else{requestLocation();}};const requestLocation=async()=>{if(!telegramService.isGeolocationAvailable()){setError('Ваш браузер не поддерживает геолокацию');setShowPermissionPrompt(true);return;}setIsLoading(true);setError('');try{// Используем специальный метод для Telegram\nconst position=await telegramService.requestGeolocation();handleLocationUpdate(position);setIsLoading(false);setShowPermissionPrompt(false);// В Telegram скрываем главную кнопку после успеха\nif(telegramService.isTelegramApp()){telegramService.hideMainButton();}}catch(error){handleLocationError(error);setIsLoading(false);// В Telegram показываем кнопку повторного запроса при ошибке\nif(telegramService.isTelegramApp()){telegramService.showRetryGeolocationButton(()=>{requestLocation();});}}};useEffect(()=>{if(!navigator.geolocation){setError('Ваш браузер не поддерживает геолокацию');setShowPermissionPrompt(true);return;}if(telegramService.isTelegramApp()){setTimeout(()=>{requestLocationWithTelegramButton();setHasBeenShown(true);},1000);return;}if('permissions'in navigator){navigator.permissions.query({name:'geolocation'}).then(result=>{if(result.state==='granted'){requestLocation();}else if(result.state==='prompt'&&!hasBeenShown){setTimeout(()=>{setShowPermissionPrompt(true);setHasBeenShown(true);},1500);}}).catch(()=>{if(!hasBeenShown){setTimeout(()=>{requestLocation();setHasBeenShown(true);},1500);}});}else{if(!hasBeenShown){setTimeout(()=>{requestLocation();setHasBeenShown(true);},1500);}}},[hasBeenShown]);const getBrowserInstructions=()=>{const userAgent=navigator.userAgent.toLowerCase();if(userAgent.includes('chrome')&&(userAgent.includes('mobile')||userAgent.includes('android'))){return{title:'Chrome на мобильном',steps:['Нажмите на три точки ⋮ в правом верхнем углу','Выберите \"Настройки\" → \"Конфиденциальность и безопасность\"','Нажмите \"Настройки сайтов\" → \"Местоположение\"','Включите \"Доступ к местоположению\"','Обновите страницу и разрешите доступ']};}else if(userAgent.includes('chrome')){return{title:'Chrome на компьютере',steps:['Нажмите на иконку замка или \"i\" слева от адресной строки','В меню \"Разрешения\" найдите \"Местоположение\"','Выберите \"Разрешить\"','Обновите страницу']};}else if(userAgent.includes('firefox')){return{title:'Firefox',steps:['Нажмите на иконку замка слева от адресной строки','В разделе \"Разрешения\" найдите \"Доступ к вашему местоположению\"','Измените на \"Разрешить\"','Обновите страницу']};}else if(userAgent.includes('safari')){return{title:'Safari',steps:['Нажмите на \"aA\" или иконку замка в адресной строке','Найдите \"Местоположение\"','Выберите \"Разрешить\"','Обновите страницу']};}else if(userAgent.includes('edg')){return{title:'Edge',steps:['Нажмите на иконку замка слева от адресной строки','В меню \"Разрешения\" найдите \"Местоположение\"','Выберите \"Разрешить\"','Обновите страницу']};}else{return{title:'Ваш браузер',steps:['Найдите настройки разрешений в адресной строке','Включите доступ к геолокации','Обновите страницу']};}};const getMobileSystemInstructions=()=>{const userAgent=navigator.userAgent.toLowerCase();if(userAgent.includes('android')){return{title:'Настройки Android',steps:['Откройте \"Настройки\" → \"Безопасность и конфидenциальность\"','Выберите \"Местоположение\" (или \"Доступ к местоположению\")','Включите \"Использовать местоположение\"','Найдите ваш браузер в списке приложений и разрешите доступ']};}else if(userAgent.includes('iphone')||userAgent.includes('ipad')||userAgent.includes('mac')){return{title:'Настройки iOS',steps:['Откройте \"Настройки\" → \"Конфиденциальность и безопасность\"','Выберите \"Службы геолокации\"','Включите \"Службы геолокации\"','Найдите ваш браузер в списке приложений и выберите \"При использовании\"']};}return null;};const instructions=getBrowserInstructions();const mobileInstructions=getMobileSystemInstructions();if(!showPermissionPrompt){return null;}return/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-[var(--tg-bg-color,#ffffff)] rounded-lg shadow-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto border border-[var(--tg-hint-color,#999999)]\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start justify-between mb-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-3\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"p-2 bg-blue-100 rounded-full\",children:/*#__PURE__*/_jsx(MapPin,{className:\"h-6 w-6 text-blue-600\"})}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-semibold text-[var(--tg-text-color,#000000)]\",children:\"\\u0412\\u043A\\u043B\\u044E\\u0447\\u0438\\u0442\\u0435 \\u0433\\u0435\\u043E\\u043B\\u043E\\u043A\\u0430\\u0446\\u0438\\u044E\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-[var(--tg-hint-color,#666666)] mt-1\",children:\"\\u0427\\u0442\\u043E\\u0431\\u044B \\u043C\\u044B \\u043C\\u043E\\u0433\\u043B\\u0438 \\u043F\\u043E\\u043A\\u0430\\u0437\\u0430\\u0442\\u044C \\u0432\\u0430\\u0448\\u0435 \\u043C\\u0435\\u0441\\u0442\\u043E\\u043F\\u043E\\u043B\\u043E\\u0436\\u0435\\u043D\\u0438\\u0435 \\u0438 \\u0431\\u043B\\u0438\\u0436\\u0430\\u0439\\u0448\\u0438\\u0435 \\u0442\\u0443\\u0430\\u043B\\u0435\\u0442\\u044B\"})]})]}),/*#__PURE__*/_jsx(Button,{variant:\"ghost\",size:\"icon\",onClick:()=>setShowPermissionPrompt(false),className:\"h-6 w-6\",children:/*#__PURE__*/_jsx(X,{className:\"h-4 w-4\"})})]}),error&&/*#__PURE__*/_jsx(\"div\",{className:\"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start gap-2\",children:[/*#__PURE__*/_jsx(AlertTriangle,{className:\"h-4 w-4 text-yellow-600 mt-0.5 flex-shrink-0\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-yellow-800\",children:error})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[telegramService.isTelegramApp()?/*#__PURE__*/_jsxs(\"div\",{className:\"bg-blue-50 border border-blue-200 rounded-md p-4\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"font-medium text-blue-900 mb-2\",children:\"\\uD83D\\uDCF1 \\u0414\\u043B\\u044F Telegram:\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-blue-800 mb-3\",children:\"\\u041D\\u0430\\u0436\\u043C\\u0438\\u0442\\u0435 \\u043D\\u0430 \\u0441\\u0438\\u043D\\u044E\\u044E \\u043A\\u043D\\u043E\\u043F\\u043A\\u043A\\u0443 \\u0432\\u043D\\u0438\\u0437\\u0443 \\u044D\\u043A\\u0440\\u0430\\u043D\\u0430 \\\"\\uD83D\\uDCCD \\u041E\\u043F\\u0440\\u0435\\u0434\\u0435\\u043B\\u0438\\u0442\\u044C \\u043C\\u0435\\u0441\\u0442\\u043E\\u043F\\u043E\\u043B\\u043E\\u0436\\u0435\\u043D\\u0438\\u0435\\\", \\u0447\\u0442\\u043E\\u0431\\u044B \\u043F\\u0440\\u0435\\u0434\\u043E\\u0441\\u0442\\u0430\\u0432\\u0438\\u0442\\u044C \\u0434\\u043E\\u0441\\u0442\\u0443\\u043F \\u043A \\u0432\\u0430\\u0448\\u0435\\u043C\\u0443 \\u043C\\u0435\\u0441\\u0442\\u043E\\u043F\\u043E\\u043B\\u043E\\u0436\\u0435\\u043D\\u0438\\u044E.\"}),/*#__PURE__*/_jsx(Button,{onClick:requestLocationWithTelegramButton,className:\"w-full\",size:\"lg\",disabled:isLoading,children:isLoading?'📍 Обработка...':'📍 Показать кнопку Telegram'})]}):/*#__PURE__*/_jsx(Button,{onClick:()=>requestLocation(),className:\"w-full\",size:\"lg\",disabled:isLoading,children:isLoading?'📍 Запрос геолокации...':'📍 Разрешить доступ к местоположению'}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-50 border border-gray-200 rounded-md p-4\",children:[/*#__PURE__*/_jsxs(\"h4\",{className:\"font-medium text-gray-900 mb-2\",children:[\"\\u041A\\u0430\\u043A \\u0432\\u043A\\u043B\\u044E\\u0447\\u0438\\u0442\\u044C \\u0433\\u0435\\u043E\\u043B\\u043E\\u043A\\u0430\\u0446\\u0438\\u044E \\u0432 \",instructions.title,\":\"]}),/*#__PURE__*/_jsx(\"ol\",{className:\"text-sm text-gray-700 space-y-1\",children:instructions.steps.map((step,index)=>/*#__PURE__*/_jsxs(\"li\",{className:\"flex items-start gap-2\",children:[/*#__PURE__*/_jsxs(\"span\",{className:\"font-medium text-blue-600\",children:[index+1,\".\"]}),/*#__PURE__*/_jsx(\"span\",{children:step})]},index))})]}),mobileInstructions&&/*#__PURE__*/_jsxs(\"div\",{className:\"bg-orange-50 border border-orange-200 rounded-md p-4\",children:[/*#__PURE__*/_jsxs(\"h4\",{className:\"font-medium text-gray-900 mb-2\",children:[mobileInstructions.title,\":\"]}),/*#__PURE__*/_jsx(\"ol\",{className:\"text-sm text-gray-700 space-y-1\",children:mobileInstructions.steps.map((step,index)=>/*#__PURE__*/_jsxs(\"li\",{className:\"flex items-start gap-2\",children:[/*#__PURE__*/_jsxs(\"span\",{className:\"font-medium text-orange-600\",children:[index+1,\".\"]}),/*#__PURE__*/_jsx(\"span\",{children:step})]},index))})]}),/*#__PURE__*/_jsx(\"div\",{className:\"bg-blue-50 border border-blue-200 rounded-md p-3\",children:/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-blue-800\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83D\\uDCA1 \\u0421\\u043E\\u0432\\u0435\\u0442:\"}),\" \\u0414\\u043B\\u044F \\u043B\\u0443\\u0447\\u0448\\u0435\\u0439 \\u0442\\u043E\\u0447\\u043D\\u043E\\u0441\\u0442\\u0438 \\u0432\\u043A\\u043B\\u044E\\u0447\\u0438\\u0442\\u0435 GPS \\u0438 \\u0443\\u0431\\u0435\\u0434\\u0438\\u0442\\u0435\\u0441\\u044C, \\u0447\\u0442\\u043E \\u0443 \\u0432\\u0430\\u0441 \\u0435\\u0441\\u0442\\u044C \\u043F\\u043E\\u0434\\u043A\\u043B\\u044E\\u0447\\u0435\\u043D\\u0438\\u0435 \\u043A \\u0438\\u043D\\u0442\\u0435\\u0440\\u043D\\u0435\\u0442\\u0443.\"]})}),/*#__PURE__*/_jsx(Button,{variant:\"outline\",onClick:()=>setShowPermissionPrompt(false),className:\"w-full\",children:\"\\u041F\\u0440\\u043E\\u0434\\u043E\\u043B\\u0436\\u0438\\u0442\\u044C \\u0431\\u0435\\u0437 \\u0433\\u0435\\u043E\\u043B\\u043E\\u043A\\u0430\\u0446\\u0438\\u0438\"})]})]})});}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}