{"ast":null,"code":"import _objectSpread from\"d:/map for cur/toilet-finder-kaliningrad/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{Modal,Form,Button,Alert,Spinner}from'react-bootstrap';import{geocodeAddress}from'../services/geocoding';import{telegramService}from'../services/telegram';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const AddToiletModal=_ref=>{let{show,onHide,onAdd,initialPosition,isTelegram}=_ref;const[formData,setFormData]=useState({name:'',address:'',latitude:(initialPosition===null||initialPosition===void 0?void 0:initialPosition.lat)||54.710,longitude:(initialPosition===null||initialPosition===void 0?void 0:initialPosition.lng)||20.510,type:'free',price:'',description:''});const[loading,setLoading]=useState(false);const[error,setError]=useState(null);const[addressLoading,setAddressLoading]=useState(false);// Обновление координат при изменении initialPosition\nuseEffect(()=>{if(initialPosition){setFormData(prev=>_objectSpread(_objectSpread({},prev),{},{latitude:initialPosition.lat,longitude:initialPosition.lng}));// Автоматически определяем адрес по кооратам\nhandleReverseGeocoding(initialPosition.lat,initialPosition.lng);}},[initialPosition]);// Обратное геокодирование - получение адреса по кооратам\nconst handleReverseGeocoding=async(lat,lng)=>{try{setAddressLoading(true);// Обратное геокодирование через Nominatim API\nconst response=await fetch(\"https://nominatim.openstreetmap.org/reverse?format=json&lat=\".concat(lat,\"&lon=\").concat(lng,\"&accept-language=ru\"));if(!response.ok){throw new Error('Reverse geocoding failed');}const data=await response.json();const address=data.display_name||'';if(address){setFormData(prev=>_objectSpread(_objectSpread({},prev),{},{address}));}}catch(err){console.warn('Failed to get address from coordinates:',err);}finally{setAddressLoading(false);}};// Геокодирование - получение коорат по адресу\nconst handleAddressChange=async address=>{setFormData(prev=>_objectSpread(_objectSpread({},prev),{},{address}));if(address.length>5){try{setLoading(true);const result=await geocodeAddress(address);if(result){setFormData(prev=>_objectSpread(_objectSpread({},prev),{},{latitude:parseFloat(result.lat),longitude:parseFloat(result.lon)}));}}catch(err){console.warn('Failed to geocode address:',err);}finally{setLoading(false);}}};// Обработка отправки формы\nconst handleSubmit=async e=>{e.preventDefault();setError(null);// Валидация\nif(!formData.name.trim()){setError('Название обязательно для заполнения');if(isTelegram){telegramService.impactOccurred('heavy');}return;}if(!formData.address.trim()){setError('Адрес обязателен для заполнения');if(isTelegram){telegramService.impactOccurred('heavy');}return;}// Для платных туалетов цена обязательна\nif(formData.type==='paid'&&!formData.price.trim()){setError('Для платных туалетов необходимо указать цену');if(isTelegram){telegramService.impactOccurred('heavy');}return;}try{setLoading(true);const toiletData={name:formData.name.trim(),address:formData.address.trim(),latitude:formData.latitude,longitude:formData.longitude,type:formData.type,price:formData.type==='paid'?formData.price.trim():undefined,description:formData.description.trim()||undefined};await onAdd(toiletData);// Сброс формы\nsetFormData({name:'',address:'',latitude:54.710,longitude:20.510,type:'free',price:'',description:''});if(isTelegram){telegramService.notificationOccurred('success');}}catch(err){console.error('Error submitting toilet:',err);setError('Не удалось добавить точку. Попробуйте позже.');if(isTelegram){telegramService.impactOccurred('heavy');}}finally{setLoading(false);}};// Обработка изменения полей формы\nconst handleChange=(field,value)=>{setFormData(prev=>_objectSpread(_objectSpread({},prev),{},{[field]:value}));setError(null);};return/*#__PURE__*/_jsxs(Modal,{show:show,onHide:onHide,centered:true,size:\"lg\",className:isTelegram?'telegram-modal':'',children:[/*#__PURE__*/_jsx(Modal.Header,{closeButton:true,children:/*#__PURE__*/_jsx(Modal.Title,{children:isTelegram?'➕ Добавить точку':'Добавить новую точку'})}),/*#__PURE__*/_jsxs(Form,{onSubmit:handleSubmit,children:[/*#__PURE__*/_jsxs(Modal.Body,{children:[error&&/*#__PURE__*/_jsx(Alert,{variant:\"danger\",dismissible:true,onClose:()=>setError(null),children:error}),/*#__PURE__*/_jsxs(Form.Group,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Form.Label,{children:\"\\u041D\\u0430\\u0437\\u0432\\u0430\\u043D\\u0438\\u0435 *\"}),/*#__PURE__*/_jsx(Form.Control,{type:\"text\",placeholder:\"\\u041D\\u0430\\u043F\\u0440\\u0438\\u043C\\u0435\\u0440: \\u0422\\u0426 \\u0415\\u0432\\u0440\\u043E\\u043F\\u0430\",value:formData.name,onChange:e=>handleChange('name',e.target.value),disabled:loading,required:true,autoFocus:true})]}),/*#__PURE__*/_jsxs(Form.Group,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Form.Label,{children:\"\\u0410\\u0434\\u0440\\u0435\\u0441 *\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"position-relative\",children:[/*#__PURE__*/_jsx(Form.Control,{type:\"text\",placeholder:\"\\u041D\\u0430\\u043F\\u0440\\u0438\\u043C\\u0435\\u0440: \\u0443\\u043B. \\u041A\\u0438\\u0435\\u0432\\u0441\\u043A\\u0430\\u044F, 1, \\u041A\\u0430\\u043B\\u0438\\u043D\\u0438\\u043D\\u0433\\u0440\\u0430\\u0434\",value:formData.address,onChange:e=>handleAddressChange(e.target.value),disabled:loading||addressLoading,required:true}),addressLoading&&/*#__PURE__*/_jsx(\"div\",{className:\"position-absolute end-0 top-50 translate-middle-y me-2\",children:/*#__PURE__*/_jsx(Spinner,{animation:\"border\",size:\"sm\"})})]}),/*#__PURE__*/_jsx(Form.Text,{className:\"text-muted\",children:\"\\u041A\\u043E\\u043E\\u0440\\u0430\\u0442\\u044B \\u043E\\u043F\\u0440\\u0435\\u0434\\u0435\\u043B\\u044F\\u044E\\u0442\\u0441\\u044F \\u0430\\u0432\\u0442\\u043E\\u043C\\u0430\\u0442\\u0438\\u0447\\u0435\\u0441\\u043A\\u0438\"})]}),/*#__PURE__*/_jsxs(Form.Group,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Form.Label,{children:\"\\u0422\\u0438\\u043F *\"}),/*#__PURE__*/_jsxs(Form.Select,{value:formData.type,onChange:e=>handleChange('type',e.target.value),disabled:loading,required:true,children:[/*#__PURE__*/_jsx(\"option\",{value:\"free\",children:\"\\u0411\\u0435\\u0441\\u043F\\u043B\\u0430\\u0442\\u043D\\u044B\\u0439\"}),/*#__PURE__*/_jsx(\"option\",{value:\"paid\",children:\"\\u041F\\u043B\\u0430\\u0442\\u043D\\u044B\\u0439\"}),/*#__PURE__*/_jsx(\"option\",{value:\"purchase_required\",children:\"\\u0422\\u043E\\u043B\\u044C\\u043A\\u043E \\u0434\\u043B\\u044F \\u043F\\u043E\\u043A\\u0443\\u043F\\u0430\\u0442\\u0435\\u043B\\u0435\\u0439\"})]})]}),formData.type==='paid'&&/*#__PURE__*/_jsxs(Form.Group,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Form.Label,{children:\"\\u0426\\u0435\\u043D\\u0430 *\"}),/*#__PURE__*/_jsx(Form.Control,{type:\"text\",placeholder:\"\\u041D\\u0430\\u043F\\u0440\\u0438\\u043C\\u0435\\u0440: 50 \\u0440\\u0443\\u0431\\u043B\\u0435\\u0439\",value:formData.price,onChange:e=>handleChange('price',e.target.value),disabled:loading,required:true})]}),/*#__PURE__*/_jsxs(Form.Group,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Form.Label,{children:\"\\u041E\\u043F\\u0438\\u0441\\u0430\\u043D\\u0438\\u0435 (\\u043D\\u0435\\u043E\\u0431\\u044F\\u0437\\u0430\\u0442\\u0435\\u043B\\u044C\\u043D\\u043E)\"}),/*#__PURE__*/_jsx(Form.Control,{as:\"textarea\",rows:3,placeholder:\"\\u0414\\u043E\\u043F\\u043E\\u043B\\u043D\\u0438\\u0442\\u0435\\u043B\\u044C\\u043D\\u0430\\u044F \\u0438\\u043D\\u0444\\u043E\\u0440\\u043C\\u0430\\u0446\\u0438\\u044F: \\u0447\\u0430\\u0441\\u044B \\u0440\\u0430\\u0431\\u043E\\u0442\\u044B, \\u043E\\u0441\\u043E\\u0431\\u0435\\u043D\\u043D\\u043E\\u0441\\u0442\\u0438 \\u0438 \\u0442.\\u0434.\",value:formData.description,onChange:e=>handleChange('description',e.target.value),disabled:loading})]}),/*#__PURE__*/_jsxs(Form.Group,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Form.Label,{children:\"\\u041A\\u043E\\u043E\\u0440\\u0434\\u0438\\u043D\\u0430\\u0442\\u044B\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"row\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"col-6\",children:/*#__PURE__*/_jsx(Form.Control,{type:\"number\",step:\"any\",placeholder:\"\\u0428\\u0438\\u0440\\u043E\\u0442\\u0430\",value:formData.latitude,onChange:e=>handleChange('latitude',e.target.value),disabled:loading})}),/*#__PURE__*/_jsx(\"div\",{className:\"col-6\",children:/*#__PURE__*/_jsx(Form.Control,{type:\"number\",step:\"any\",placeholder:\"\\u0414\\u043E\\u043B\\u0433\\u043E\\u0442\\u0430\",value:formData.longitude,onChange:e=>handleChange('longitude',e.target.value),disabled:loading})})]}),/*#__PURE__*/_jsx(Form.Text,{className:\"text-muted\",children:\"\\u041E\\u043F\\u0440\\u0435\\u0434\\u0435\\u043B\\u044F\\u044E\\u0442\\u0441\\u044F \\u0430\\u0432\\u0442\\u043E\\u043C\\u0430\\u0442\\u0438\\u0447\\u0435\\u0441\\u043A\\u0438 \\u043F\\u043E \\u0430\\u0434\\u0440\\u0435\\u0441\\u0443\"})]})]}),/*#__PURE__*/_jsxs(Modal.Footer,{children:[/*#__PURE__*/_jsx(Button,{variant:\"secondary\",onClick:onHide,disabled:loading,children:\"\\u041E\\u0442\\u043C\\u0435\\u043D\\u0430\"}),/*#__PURE__*/_jsxs(Button,{type:\"submit\",variant:\"primary\",disabled:loading,className:\"d-flex align-items-center gap-2\",children:[loading&&/*#__PURE__*/_jsx(Spinner,{animation:\"border\",size:\"sm\"}),loading?'Добавление...':'Добавить точку']})]})]})]});};export default AddToiletModal;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}